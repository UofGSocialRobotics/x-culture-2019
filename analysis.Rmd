---
title: "X-Culture Pilot Analysis"
author: "csaund"
date: "13/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(pwr)
library(ordinal)
```

### Gesture Map
* West 1 - Unpolite
* West 2 - Entity
* West 3 - Audience
* West 4 - Anything
* West 5 - Specific

* East 1 - Color Fists
* East 2 - Battle
* East 3 - Arm Cross
* East 4 - Rainbow


### Load and clean data 
```{r}

load_clean_data <- function(filepath) {
  data <- read.csv(filepath) %>% 
  dplyr::select(Answer.buttheads,
                Answer.close,
                Answer.cometogether,
                Answer.communicate,
                Answer.control,
                Answer.disagreement,
                Answer.worktogether,
                Answer.goal,
                Answer.getalong,
                Answer.overlap,
                Answer.protected,
                Answer.tension,
                Answer.unified,
                Answer.vid_id) 

  data$Answer.vid_id <- gsub("https://s3.us-east-2.amazonaws.com/metaphoric-gestures-x-culture/*", 
                             "\\1", 
                             data$Answer.vid_id)
  return(data)
}

d1 <- load_clean_data("./data/XC_5_western_gest_western_participants.csv")
d2 <- load_clean_data("./data/XC_gest_full_western_participants_5.csv")
d3 <- load_clean_data("./data/XC_gest_full_western_participants_4.csv")
d4 <- load_clean_data("./data/XC_pilot_gest_2.csv")

data <- rbind(d1, d2, d3, d4)

eastern <- data %>%
  filter(grepl("eastern", Answer.vid_id))

western <- data %>%
  filter(grepl("western", Answer.vid_id))

# need to get condition
make_it_pretty <- function(data, condition_name) {
  df <- data %>%
    mutate(condition=Answer.vid_id) %>%
    select(condition, Answer.buttheads,
                Answer.close,
                Answer.cometogether,
                Answer.communicate,
                Answer.control,
                Answer.disagreement,
                Answer.goal,
                Answer.getalong,
                Answer.overlap,
                Answer.protected,
                Answer.tension,
                Answer.unified,
                Answer.worktogether) %>%
    gather("statement_measure", score, 
                Answer.buttheads,
                Answer.close,
                Answer.cometogether,
                Answer.communicate,
                Answer.control,
                Answer.disagreement,
                Answer.goal,
                Answer.getalong,
                Answer.overlap,
                Answer.protected,
                Answer.tension,
                Answer.unified,
                Answer.worktogether)
  return(df)
}


west_cleaned <- make_it_pretty(western, "western")
east_cleaned <- make_it_pretty(eastern, "eastern")
```


Clean that shit up
```{r}
format_indiv_gesture <- function (gesture_num, condition1, condition2) {
  cleaned <- west_cleaned %>%
    mutate(ID=row_number()) %>%
    filter(grepl(gesture_num, condition)) %>%
    mutate(condition=(ifelse(grepl("-0", condition), "original", condition))) %>%
    mutate(condition=(ifelse(grepl("-1", condition), condition1, condition))) %>%
    mutate(condition=(ifelse(grepl("-2", condition), condition2, condition)))   
  return(cleaned)
}

west_gest_1_clean <- format_indiv_gesture("1-", "intertwine", "collide")
# all good

west_gest_2_clean <- format_indiv_gesture("2-", "open_palm", "in_chest")
# need more original

west_gest_3_clean <- format_indiv_gesture("3-", "no_circle", "palm_up")

west_gest_4_clean <- format_indiv_gesture("4-", "frame", "cover")
# need more cover

west_gest_5_clean <- format_indiv_gesture("5-", "bowl", "forward")
# need more original and forward

east_gest_1_clean <- east_cleaned %>%
  mutate(ID=row_number()) %>%
  filter(grepl("1-", condition))

east_gest_2_clean <- east_cleaned %>%
  mutate(ID=row_number()) %>%
  filter(grepl("2-", condition))

east_gest_3_clean <- east_cleaned %>%
  mutate(ID=row_number()) %>%
  filter(grepl("3-", condition))
```

Let's just blindly plot things and see what happens
```{r}
create_bar <- function(data) {
  bar_plot <- ggplot(data, aes(x=statement_measure, y=score, fill=condition)) + 
      geom_bar(stat="identity", position="dodge") + 
      facet_wrap(~statement_measure, scale="free")  
  return(bar_plot)
}

create_density <- function(data) {
  ## density of distributions
  density_plot <- ggplot(data, aes(x=score, fill=condition)) + 
    geom_density(alpha=0.3, stat="density", adjust=0.85) +
    facet_wrap(~statement_measure, scale="free") + 
    ggtitle("Unpolite Example distribution of statement ratings") 
  return(density_plot)
}

## get dat violin data

create_violin <- function(data) {
  violin_plot <- ggplot(data, aes(condition, score)) + 
    geom_violin(aes(fill=condition, alpha=0.5), scale="area", draw_quantiles = c(0.25, 0.5, 0.75)) +
    facet_wrap(~statement_measure) + 
    labs(
      title = "Violin plot (density) of ranked responses per condition by statement"   ,
      caption = "Horizontal lines are drawn at the 0.25, 0.5, and 0.75 quantiles of the distribution."
    )
  return(violin_plot)
}
```


```{r}
west_1_bar <- create_bar(west_gest_1_clean)
west_1_dense <- create_density(west_gest_1_clean)
west_1_violin <- create_violin(west_gest_1_clean)

west_1_west_2_bar <- create_bar(west_gest_2_clean)
west_2_dense <- create_density(west_gest_2_clean)
west_2_violin <- create_violin(west_gest_2_clean)

west_3_bar <- create_bar(west_gest_3_clean)
west_3_dense <- create_density(west_gest_3_clean)
west_3_violin <- create_violin(west_gest_3_clean)

west_4_bar <- create_bar(west_gest_4_clean)
west_4_dense <- create_density(west_gest_4_clean)
west_4_violin <- create_violin(west_gest_4_clean)

west_5_bar <- create_bar(west_gest_5_clean)
west_5_dense <- create_density(west_gest_5_clean)
west_5_violin <- create_violin(west_gest_5_clean)

east_1_bar <- create_bar(east_gest_1_clean)
east_1_dense <- create_density(east_gest_1_clean)
east_1_violin <- create_violin(east_gest_1_clean)

east_2_bar <- create_bar(east_gest_2_clean)
east_2_dense <- create_density(east_gest_2_clean)
east_2_violin <- create_violin(east_gest_2_clean)

easteast_3_bar <- create_bar(east_gest_3_clean)
east_3_dense <- create_density(east_gest_3_clean)
east_3_violin <- create_violin(east_gest_3_clean)
```


## Stats on Stats on Stats
```{r}
# t.tests to determine statistical differences between statement responses
get_vals <- function(data, condition_name, statement) {
  print(condition_name)
  print(statement)
  ret <- data %>%
    filter(condition==condition_name) %>%
    filter(statement_measure==statement)
  ret <- ret$score  
  return(ret)
}

## Butt heads
west_1_0_butthead <- get_vals(west_gest_1_clean, "original", "Answer.buttheads")
west_1_1_butthead <- get_vals(west_gest_1_clean, "intertwine", "Answer.buttheads")
west_1_2_butthead <- get_vals(west_gest_1_clean, "collide", "Answer.buttheads")

# t.tests to determine statistical differences?
# They are different/same as original
p_butt_1_0_1 <- t.test(west_1_0_butthead, west_1_1_butthead)[3]
p_butt_1_0_2 <- t.test(west_1_0_butthead, west_1_2_butthead)[3]
# They are different from each other
p_butt_1_1_2 <- t.test(west_1_1_butthead, west_1_2_butthead)[3]

## Tension
west_1_0_tension <- get_vals(west_gest_1_clean, "original", "Answer.tension")
west_1_1_tension <- get_vals(west_gest_1_clean, "intertwine", "Answer.tension")
west_1_2_tension <- get_vals(west_gest_1_clean, "collide", "Answer.tension")

# t.tests to determine statistical differences?
# They are different/same as original
p_tense_1_0_1 <- t.test(west_1_0_tension, west_1_1_tension)[3]
p_tense_1_0_2 <- t.test(west_1_0_tension, west_1_2_tension)[3]
# They are different from each other
p_tense_1_1_2 <- t.test(west_1_1_tension, west_1_2_tension)[3]

statement <- rep(c("Answer.buttheads", "Answer.tension"), each=9)
cond1 <- rep(rep(c("original", "intertwine", "collide"), 3), 2)
cond2 <- rep(rep(c("original", "intertwine", "collide"), each=3), 2)
df <- data.frame(statement, cond1, cond2) 
  #transform(p=as.numeric(t.test(
  #          get_vals(west_gest_1_clean, cond1, statement),
  #          get_vals(west_gest_1_clean, cond2, statement))[3]))

do_t_test <- function(cond1, cond2, statement) {
  return(as.numeric(t.test(
            get_vals(west_gest_1_clean, cond1, statement),
            get_vals(west_gest_1_clean, cond2, statement))[3]))
}

# Gross but oh well
sig <- function(p) {
  if(p < 0.0005) {
    return("***")
  }
  if(p < 0.005) {
    return("**")
    }
  if(p < 0.05) {
    return("*")
  }
  return ("")
}

df$p <- mapply(do_t_test, df$cond1, df$cond2, df$statement)
df$sig <- mapply(sig, df$p)

df$p <- with(df, as.numeric(t.test(
            get_vals(west_gest_1_clean, cond1, statement),
            get_vals(west_gest_1_clean, cond2, statement))[3]))


t.test(get_vals(west_gest_1_clean, "original", "Answer.buttheads"),
       get_vals(west_gest_1_clean, "intertwine", "Answer.buttheads"))[3]
## statement  cond1  cond2   p  sig(**)
```


Visualize these significant differences with a difference matrix. 
We will see that sometimes, one metaphor dominates and we see non-significant
differences between the original and one of the manipulations, but a significant
difference between the original and the other manipulation. However, when we
observe these responses in conjunction with the other data, we see that while 
peoples explicit rankings of the gesture change, they are able to decode
nuances in the gesture.
```{r}
## for buttheads
##  c1  c2   p
## 1-0  1-0  1
## 1-1  1-0  0.9394285
## 1-2  1-0  0.001962781
## 1-0  1-1  0.9394285
## 1-1  1-1  1
## 1-2  1-1  0.006549727
## 1-0  1-2  0.001962781
## 1-1  1-2  0.006549727
## 1-2  1-2  1
##   Var1 Var2 value
## 1  mpg  mpg  1.00
## 2 disp  mpg -0.85
## 3   hp  mpg -0.78
## 4 drat  mpg  0.68
## 5   wt  mpg -0.87
## 6 qsec  mpg  0.42

c1 <- rep(c("1-0", "1-1", "1-2"), 3)
c2 <- rep(c("1-0", "1-1", "1-2"), each=3)
p <- c(1, 0.9394285, 0.001962781, 0.9394285, 1, 0.006549727, 0.001962781, 0.006549727, 1)
df <- data.frame(c1, c2, p)

library(ggplot2)
ggplot(data = df, aes(x=c1, y=c2, fill=p)) + 
  geom_tile()
```