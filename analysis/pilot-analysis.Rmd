---
title: "XC Analysis 2019 (fixed questions)"
author: "csaund"
date: "6/27/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(ggplot2)
library(pwr)
library(ordinal)
library(gridExtra)
library(RColorBrewer)
library(knitr)
library(rlist)
library(scales)
```


### Naming scheme
wg1.0.e == "western gesture 1, condition 0, eastern viewer culture"
eg4.2.w == "eastern gesture 4 condition 2, western viewer culture"

# Part One: Overlapping Metaphors!?!?

## Load 'N' Wrangle

### Western Participants
Load these bad larrys (straight from mTurk template)
```{r load_data_1}
xcdata <- rbind(read.csv('xc_pilot_fixed_questions.csv'), read.csv('xc_pilot_fixed_questions2.csv')) %>%
  select(Answer.accessible, Answer.confident, Answer.conflict, Answer.control, 
         Answer.dominant, Answer.goal, Answer.many, Answer.members, 
         Answer.open, Answer.sure, Answer.tension, Answer.worktogether,
         Answer.vid_id)

wg1.0.w <- xcdata %>%
  filter(Answer.vid_id == 
           "https://s3.us-east-2.amazonaws.com/metaphoric-gestures-x-culture/western_gest_1-0.mov") %>%
  select(-Answer.vid_id)

wg1.1.w <- xcdata %>%
  filter(Answer.vid_id == 
           "https://s3.us-east-2.amazonaws.com/metaphoric-gestures-x-culture/western_gest_1-1.mov") %>%
  select(-Answer.vid_id)

wg1.2.w <- xcdata %>%
  filter(Answer.vid_id == 
           "https://s3.us-east-2.amazonaws.com/metaphoric-gestures-x-culture/western_gest_1-2.mov") %>%
  select(-Answer.vid_id)

wg2.0.w <- xcdata %>%
  filter(Answer.vid_id == 
           "https://s3.us-east-2.amazonaws.com/metaphoric-gestures-x-culture/western_gest_2-0.mov") %>%
  select(-Answer.vid_id)

wg2.1.w <- xcdata %>%
  filter(Answer.vid_id == 
           "https://s3.us-east-2.amazonaws.com/metaphoric-gestures-x-culture/western_gest_2-1.mov") %>%
  select(-Answer.vid_id)

wg2.2.w <- xcdata %>%
  filter(Answer.vid_id == 
           "https://s3.us-east-2.amazonaws.com/metaphoric-gestures-x-culture/western_gest_2-2.mov") %>%
  select(-Answer.vid_id)

wg3.0.w <- xcdata %>%
  filter(Answer.vid_id == 
           "https://s3.us-east-2.amazonaws.com/metaphoric-gestures-x-culture/western_gest_3-0.mov") %>%
  select(-Answer.vid_id)

wg3.1.w <- xcdata %>%
  filter(Answer.vid_id == 
           "https://s3.us-east-2.amazonaws.com/metaphoric-gestures-x-culture/western_gest_3-1.mov") %>%
  select(-Answer.vid_id)

wg3.2.w <- xcdata %>%
  filter(Answer.vid_id == 
           "https://s3.us-east-2.amazonaws.com/metaphoric-gestures-x-culture/western_gest_3-2.mov") %>%
  select(-Answer.vid_id)
```


Also load these buggerinos (from psytoolkit template)
```{r load_western_gestures}
psydata <- rbind(read.csv('psytoolkit_pilot.csv'), 
                 read.csv('psytoolkit_pilot2.csv'),
                 read.csv('w-part-e-gest-pilot.csv'),
                 read.csv('w-part-e-gest-top90.csv'),
                 read.csv('w-part-e-gest-total.csv')) %>% 
  na.omit() %>%
  distinct()
colnames(psydata) <- c("participantID", "vid_id", "rand", "free_response", 
                 "Answer.many", "Answer.members", "Answer.conflict", "Answer.tension",
                 "Answer.open", "Answer.accessible", "Answer.control", "Answer.dominant",
                 "Answer.worktogether", "Answer.goal", "Answer.sure", "Answer.confident",
                 "endcode", "t_start", "t_end", "t_total") 

wg4.0.w <- psydata %>%
  filter(vid_id == 
           "334666350") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg4.1.w <- psydata %>%
  filter(vid_id == 
           "334666369") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg4.2.w <- psydata %>%
  filter(vid_id == 
           "334666395") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg5.0.w <- psydata %>%
  filter(vid_id == 
           "334666150") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg5.1.w <- psydata %>%
  filter(vid_id == 
           "334666125") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg5.2.w <- psydata %>%
  filter(vid_id == 
           "334666100") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)
 

## once more for eastern gestures

eg1.0.w <- psydata %>%
  filter(vid_id == 
           "334668817") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg1.1.w <- psydata %>%
  filter(vid_id == 
           "334668844") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg1.2.w <- psydata %>%
  filter(vid_id == 
           "334668883") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg2.0.w <- psydata %>%
  filter(vid_id == 
           "334668913") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg2.1.w <- psydata %>%
  filter(vid_id == 
           "334668938") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg2.2.w <- psydata %>%
  filter(vid_id == 
           "334668968") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg3.0.w <- psydata %>%
  filter(vid_id == 
           "334668989") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg3.1.w <- psydata %>%
  filter(vid_id == 
           "334669043") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg3.2.w <- psydata %>%
  filter(vid_id == 
           "334669066") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg4.0.w <- psydata %>%
  filter(vid_id == 
           "334668792") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg4.1.w <- psydata %>%
  filter(vid_id == 
           "334668766") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg4.2.w <- psydata %>%
  filter(vid_id == 
           "334668728") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

```



### Eastern Participants
```{r load_eastern_participants}
j_psydata <- rbind(read.csv('japanese-pilot-data.csv'), 
                   read.csv('japanese-west-1-2-3.csv'),
                   read.csv('japanese-west-1-4-5.csv'),
                   read.csv('e-part-w-gest-1.csv'),
                   read.csv('e-part-w-gest-2.csv'),
                   read.csv('e-part-w-gest-t.csv'),
                   read.csv('e-part-w-gest-14.csv'),
                   read.csv('e-part-w-gest-16.csv'),
                   read.csv('e-part-w-gest-17.csv'),
                   read.csv('e-part-w-gest-18.csv')) %>% 
  na.omit() %>%
  distinct()
colnames(j_psydata) <- c("participantID", "vid_id", "rand", "free_response", 
                 "Answer.many", "Answer.members", "Answer.conflict", "Answer.tension",
                 "Answer.open", "Answer.accessible", "Answer.control", "Answer.dominant",
                 "Answer.worktogether", "Answer.goal", "Answer.sure", "Answer.confident",
                 "endcode", "t_start", "t_end", "t_total") 

wg1.0.e <- j_psydata %>%
  filter(vid_id == 
           "334661117") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg1.1.e <- j_psydata %>%
  filter(vid_id == 
           "334666262") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg1.2.e <- j_psydata %>%
  filter(vid_id == 
           "334666284") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg2.0.e <- j_psydata %>%
  filter(vid_id == 
           "334666214") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg2.1.e <- j_psydata %>%
  filter(vid_id == 
           "334666167") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg2.2.e <- j_psydata %>%
  filter(vid_id == 
           "334666191") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg3.0.e <- j_psydata %>%
  filter(vid_id == 
           "334666300") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg3.1.e <- j_psydata %>%
  filter(vid_id == 
           "334666234") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg3.2.e <- j_psydata %>%
  filter(vid_id == 
           "334666324") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg4.0.e <- j_psydata %>%
  filter(vid_id == 
           "334666350") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg4.1.e <- j_psydata %>%
  filter(vid_id == 
           "334666369") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg4.2.e <- j_psydata %>%
  filter(vid_id == 
           "334666395") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg5.0.e <- j_psydata %>%
  filter(vid_id == 
           "334666150") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg5.1.e <- j_psydata %>%
  filter(vid_id == 
           "334666125") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

wg5.2.e <- j_psydata %>%
  filter(vid_id == 
           "334666100") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

## once more for eastern gestures

eg1.0.e <- j_psydata %>%
  filter(vid_id == 
           "334668817") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg1.1.e <- j_psydata %>%
  filter(vid_id == 
           "334668844") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg1.2.e <- j_psydata %>%
  filter(vid_id == 
           "334668883") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg2.0.e <- j_psydata %>%
  filter(vid_id == 
           "334668913") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg2.1.e <- j_psydata %>%
  filter(vid_id == 
           "334668938") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg2.2.e <- j_psydata %>%
  filter(vid_id == 
           "334668968") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg3.0.e <- j_psydata %>%
  filter(vid_id == 
           "334668989") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg3.1.e <- j_psydata %>%
  filter(vid_id == 
           "334669043") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg3.2.e <- j_psydata %>%
  filter(vid_id == 
           "334669066") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg4.0.e <- j_psydata %>%
  filter(vid_id == 
           "334668792") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg4.1.e <- j_psydata %>%
  filter(vid_id == 
           "334668766") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

eg4.2.e <- j_psydata %>%
  filter(vid_id == 
           "334668728") %>%
  select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)

# eg5.0.e <- j_psydata %>%
#   filter(vid_id == 
#            "334666150") %>%
#   select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)
# 
# eg5.1.e <- j_psydata %>%
#   filter(vid_id == 
#            "334666125") %>%
#   select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)
# 
# eg5.2.e <- j_psydata %>%
#   filter(vid_id == 
#            "334666100") %>%
#   select(-vid_id, -rand, -participantID, -t_start, -t_end, -t_total, -endcode, -free_response)
```


### Spot checks 
some things should correlate, others should not. IE the questions that go together should correlate. 
accessible <--> open
confident <--> sure
conflict <--> tension
dominant <--> control
goal <--> worktogether
many <--> members

So now we group the metaphor measures by group and facet wrap by that. EZ

```{r add_groups}
add_groups <- function(data) {
  data$group <- ""
  for(row in 1:nrow(data)) {
    if (data$metaphor_measure[row] == "Answer.accessible") {
               data$group[row] <- "openness"
    } else if (data$metaphor_measure[row] == "Answer.open") {
              data$group[row] <- "openness"
    } else if (data$metaphor_measure[row] == "Answer.confident") {
              data$group[row] <- "certainty"
    } else if (data$metaphor_measure[row] == "Answer.sure") {
              data$group[row] <- "certainty"
    } else if (data$metaphor_measure[row] == "Answer.conflict") {
              data$group[row] <- "conflict"
    } else if (data$metaphor_measure[row] == "Answer.tension") {
              data$group[row] <- "conflict"
    } else if (data$metaphor_measure[row] == "Answer.control") {
               data$group[row] <- "control"
    } else if (data$metaphor_measure[row] == "Answer.dominant") {
              data$group[row] <- "control"
    } else if (data$metaphor_measure[row] == "Answer.goal") {
              data$group[row] <- "unity"
    } else if (data$metaphor_measure[row] == "Answer.worktogether") {
              data$group[row] <- "unity"
    } else if (data$metaphor_measure[row] == "Answer.many") {
              data$group[row] <- "size"
    } else if (data$metaphor_measure[row] == "Answer.members") {
              data$group[row] <- "size"              
    } else {
      # for some reason it's not recognizing the annoyed case, so let's throw it in the else
      # cause that seems safe.
      data$group[row] <- "other"
    }
  }
  return(data)
}
```


Create grouped overlay of correlated questions. Violin plot of question correlations by group (for single conditions of a single gesture)
```{r create_overlay_graphs}
create_grouped_overlay <- function(data) {
  p <- ggplot(data) + 
    aes(x=factor(nrow(data)),y=score,fill=metaphor_measure)+
    geom_violin(alpha=0.3,position="identity") +
    facet_wrap("group")  
  return(p)    
}
```

This graph shows the correlation of the grouped variables. We want them to be highly correlated with each other, and preferably not super correlated with one another. This should hold moreso for the extreme versions of the gestures.


Really could have correlation plot w Q1 on X and Q2 on Y but those don't look great and we shouldn't expect them to... 

### Correlation Matrix of questions
Get wrapped plot of correlations across conditions for same gesture
```{r correlation_matrices}
## Go through and populate with metaphors and difference values
create_difference_matrix <- function(data) {
  difference_table <- data.frame(
    Question1 = c(""),
    Question2 = c(""),
    Rsq = c(""),
    stringsAsFactors=FALSE
  )
  
  ### TEMP -- RENAME THINGS SO THEY'RE NEXT TO THE RIGHT ONES
  ### THIS COULD BE DISASTEROUS!!!!
  colnames(data)[colnames(data)=="Answer.worktogether"] <- "unity.worktogether"
  colnames(data)[colnames(data)=="Answer.goal"] <- "unity.goal"
  colnames(data)[colnames(data)=="Answer.tension"] <- "conflict.tension"
  colnames(data)[colnames(data)=="Answer.conflict"] <- "conflict.conflict"
  colnames(data)[colnames(data)=="Answer.many"] <- "size.many"
  colnames(data)[colnames(data)=="Answer.members"] <- "size.members"
  colnames(data)[colnames(data)=="Answer.dominant"] <- "control.dominant"
  colnames(data)[colnames(data)=="Answer.control"] <- "control.control"
  colnames(data)[colnames(data)=="Answer.open"] <- "openness.open"
  colnames(data)[colnames(data)=="Answer.accessible"] <- "openness.accessible"
  colnames(data)[colnames(data)=="Answer.sure"] <- "certainty.sure"
  colnames(data)[colnames(data)=="Answer.confident"] <- "certainty.confident"

  
  
  ###
  
  metas = colnames(data)
  
  for(metaphor in metas) {
    for(meta in rev(metas)) {
      diff <- cor(data[meta], data[metaphor])
      row <- c(metaphor, meta, diff)
      difference_table <- rbind(difference_table, row)  
    }
  }
  
  difference_table <- difference_table[-1,]
  difference_table$Rsq <- as.numeric(as.character(difference_table$Rsq))
  
  return(difference_table)
}
```

```{r plot_difference_matrices}
plot_diff_matrix <- function(matrix, low_col, high_col, mid_col, title) {
  p <- ggplot(data=matrix, aes(x=Question1, y=Question2, fill=Rsq)) + 
    geom_tile(color="white") +
    scale_fill_gradient2(low=low_col, high=high_col, mid=mid_col,
                         midpoint=0.25, space="Lab") +
    theme_minimal() +
    coord_fixed() +
    theme_bw() +
    theme(axis.text.x=element_text(angle=90),
        axis.ticks=element_blank(),
        axis.line=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_line(color='#eeeeee')) +
      ggtitle(title)
  return(p)
}

plot_diff_matrix_pretty <- function(matrix, t="") {
  plot_diff_matrix(matrix, "palevioletred", "royalblue4", "aliceblue", title=t)
}
```


### Violin plots of responses to questions
```{r violin_density}
plot_violin_density <- function(d0, d1, d2) {
  g <- ggplot(rbind(d0, d1, d2), aes(vid, score)) + 
    geom_violin(aes(fill=vid, alpha=0.5), scale="count", draw_quantiles = c(0.25, 0.5, 0.75)) +
    facet_wrap(~metaphor_measure) + 
    labs(
      title = "Violin plot (density) of ranked responses per condition by metaphor",
      caption = "Horizontal lines are drawn at the 0.25, 0.5, and 0.75 quantiles of the distribution."
    )
  return(g)
}

plot_violin_density_grouped <- function(d0, d1, d2) {
  g <- ggplot(rbind(d0, d1, d2), aes(vid, score)) + 
    geom_violin(aes(fill=vid, alpha=0.5), scale="count", draw_quantiles = c(0.25, 0.5, 0.75)) +
    facet_wrap(~group) + 
    labs(
      title = "Violin plot (density) of ranked responses per condition by metaphor"   ,
      caption = "Horizontal lines are drawn at the 0.25, 0.5, and 0.75 quantiles of the distribution."
    )
  return(g)
}

plot_violin_density_group_overlay <- function(d0, d1, d2) {
  g <- ggplot(rbind(d0, d1, d2)) + 
    aes(x=factor(nrow(d0)),y=score,fill=vid)+
    geom_violin(alpha=0.3,position="identity", adjust=1.3) +
    facet_wrap("group") +
    labs(
      title = "Violin plot (density) of ranked responses per condition by metaphor grouping"
    )
  return(g)
}
```


### Density plot? 
Regrouping data in a potentially horrifying way. Need to make sure questions make sense...

Group it all together and do it by group but you can also just do it by groups and facet wrap by metaphor measure for 
indiv question results. 
```{r density_plot_coding}
plot_group_density <- function(d0, d1, d2) {
  p <- ggplot(rbind(d0, d1, d2), aes(x=score, fill=vid)) + 
      geom_density(alpha=0.3, stat="density", adjust=1.2) +
      facet_wrap(~group, scale="free")
  return(p)  
}

plot_question_density <- function(d0, d1, d2) {
  p <- ggplot(rbind(d0, d1, d2), aes(x=score, fill=vid)) + 
      geom_density(alpha=0.3, stat="density", adjust=1.2) +
      facet_wrap(~metaphor_measure, scale="free")
  return(p)  
}
```


#### Put it together and how do you do? Bibbity Bobbity BAM.
```{r big_correlational_matrices}
## random helpers
gather_select <- function(d) {
  d <- d %>%
    gather("metaphor_measure", "score", 1:12) %>%
    select("metaphor_measure", "score")
}

wrangle_data <- function(d, name="data") {
  gathered <- gather_select(d)
  grouped <- add_groups(gathered)
  overlay_plot <- create_grouped_overlay(grouped)
  diff_mat <- create_difference_matrix(d)
  diff_mat$vid <- name
  list_of_returns <- list("gathered" = gathered, "grouped" = grouped, "overlay_plot" = overlay_plot, "diff_mat" = diff_mat)
  return(list_of_returns)
}

do_the_thing <- function(d0, d1, d2, n0 = "original", n1 = "a_condition1", n2 = "z_condition2", gesture = "single") {
  d0_data <- wrangle_data(d0, n0)
  d1_data <- wrangle_data(d1, n1)
  d2_data <- wrangle_data(d2, n2)
  
  graph_title <- paste("Correlation of questions for", gesture, "gesture across conditions.")
  
  overlays <- list("d0_overlay" = d0_data$overlay_plot, 
                   "d1_overlay" = d1_data$overlay_plot, 
                   "d2_overlay" = d2_data$overlay_plot)
  difference_matrix <- plot_diff_matrix_pretty(rbind(d0_data$diff_mat, d1_data$diff_mat, d2_data$diff_mat), 
                      graph_title) + 
                      facet_wrap("vid")  
  
  ## rename some things for the density plots
  db_named <- d0_data$gathered
  da_named <- d1_data$gathered
  dc_named <- d2_data$gathered
  db_named$vid = "original"
  da_named$vid = "collide"
  dc_named$vid = "intertwine"
  d0_grouped_named <- add_groups(da_named)
  d1_grouped_named <- add_groups(db_named)
  d2_grouped_named <- add_groups(dc_named)
  
  ## violin density plot 
 violin_density_question <- plot_violin_density(da_named, db_named, dc_named) 
 violin_density_grouped <- plot_violin_density_grouped(d0_grouped_named, d1_grouped_named, d2_grouped_named)
 violin_dnesity_grouped_overlay <- plot_violin_density_group_overlay(d0_grouped_named, d1_grouped_named, d2_grouped_named)
 
 ## plot density plot -- with groups
 density_grouped <- plot_group_density(d0_grouped_named, d1_grouped_named, d2_grouped_named)
 density_question <- plot_question_density(d0_grouped_named, d1_grouped_named, d2_grouped_named)
 
 return_list <- list("overlays" = overlays, 
                     "correlation_matrix" = difference_matrix, 
                     "violin_density_question" = violin_density_question, 
                     "violin_density_grouped" = violin_density_grouped,
                     "violin_density_grouped_overlay" = violin_dnesity_grouped_overlay,
                     "density_grouped" = density_grouped, 
                     "density_question" = density_question)
}

all_wg1_data <- do_the_thing(wg1.0.w, wg1.1.w, wg1.2.w, "original", "intertwine", "collide")
all_wg2_data <- do_the_thing(wg2.0.w, wg2.1.w, wg2.2.w)
all_wg3_data <- do_the_thing(wg3.0.w, wg3.1.w, wg3.2.w)
all_wg4_data <- do_the_thing(wg4.0.w, wg4.1.w, wg4.2.w)
all_wg5_data <- do_the_thing(wg5.0.w, wg5.1.w, wg5.2.w)

all_western_correlational_data.w <- plot_diff_matrix_pretty(rbind(create_difference_matrix(wg1.0.w), 
                                                        create_difference_matrix(wg1.1.w), 
                                                        create_difference_matrix(wg1.2.w),
                                                        create_difference_matrix(wg2.0.w), 
                                                        create_difference_matrix(wg2.1.w), 
                                                        create_difference_matrix(wg2.2.w),
                                                        create_difference_matrix(wg4.0.w), 
                                                        create_difference_matrix(wg4.1.w), 
                                                        create_difference_matrix(wg4.2.w),
                                                        create_difference_matrix(wg5.0.w), 
                                                        create_difference_matrix(wg5.1.w),
                                                        create_difference_matrix(wg5.2.w),
                                                        create_difference_matrix(wg3.0.w), 
                                                        create_difference_matrix(wg3.1.w), 
                                                        create_difference_matrix(wg3.2.w)), 
    "Correlation of questions across all gesture conditions for western participants")


all_western_correlational_data.e <- plot_diff_matrix_pretty(rbind(create_difference_matrix(wg1.0.e), 
                                                        create_difference_matrix(wg1.1.e), 
                                                        create_difference_matrix(wg1.2.e),
                                                        create_difference_matrix(wg2.0.e), 
                                                        create_difference_matrix(wg2.1.e), 
                                                        create_difference_matrix(wg2.2.e),
                                                        create_difference_matrix(wg4.0.e), 
                                                        create_difference_matrix(wg4.1.e), 
                                                        create_difference_matrix(wg4.2.e),
                                                        create_difference_matrix(wg5.0.e), 
                                                        create_difference_matrix(wg5.1.e),
                                                        create_difference_matrix(wg5.2.e),
                                                        create_difference_matrix(wg3.0.e), 
                                                        create_difference_matrix(wg3.1.e), 
                                                        create_difference_matrix(wg3.2.e)), 
    "Correlation of questions across all gesture conditions for western participants") 


all_eastern_correlational_data.w <- plot_diff_matrix_pretty(rbind(create_difference_matrix(eg1.0.w), 
                                                        create_difference_matrix(eg1.1.w), 
                                                        create_difference_matrix(eg1.2.w),
                                                        create_difference_matrix(eg2.0.w), 
                                                        create_difference_matrix(eg2.1.w), 
                                                        create_difference_matrix(eg2.2.w),
                                                        create_difference_matrix(eg4.0.w), 
                                                        create_difference_matrix(eg4.1.w), 
                                                        create_difference_matrix(eg4.2.w),
                                                        create_difference_matrix(eg3.0.w), 
                                                        create_difference_matrix(eg3.1.w), 
                                                        create_difference_matrix(eg3.2.w)), 
    "Correlation of questions across all gesture conditions for western participants")


all_eastern_correlational_data.e <- plot_diff_matrix_pretty(rbind(create_difference_matrix(eg1.0.e), 
                                                        create_difference_matrix(eg1.1.e), 
                                                        create_difference_matrix(eg1.2.e),
                                                        create_difference_matrix(eg2.0.e), 
                                                        create_difference_matrix(eg2.1.e), 
                                                        create_difference_matrix(eg2.2.e),
                                                        create_difference_matrix(eg4.0.e), 
                                                        create_difference_matrix(eg4.1.e), 
                                                        create_difference_matrix(eg4.2.e),
                                                        create_difference_matrix(eg3.0.e), 
                                                        create_difference_matrix(eg3.1.e), 
                                                        create_difference_matrix(eg3.2.e)), 
    "Correlation of questions across all gesture conditions for western participants") 



## save some other things too why not
ggsave(filename = "all_unpolite_data--violin_density_grouped.png", plot = all_wg1_data$violin_density_grouped_overlay)
# ggsave(filename = "all_entity_data--violin_density_grouped.png", plot = all_wg2_data$violin_density_grouped_overlay)
# ggsave(filename = "all_audience_data--violin_density_grouped.png", plot = all_wg3_data$violin_density_grouped_overlay)
# ggsave(filename = "all_protected_data--violin_density_grouped.png", plot = all_wg4_data$violin_density_grouped_overlay)
# ggsave(filename = "all_bowl_data--violin_density_grouped.png", plot = all_wg5_data$violin_density_grouped_overlay)
# 
# ggsave(filename = "all_western_correlational_data.png", plot = all_western_correlational_data)
```
## Correlations
Western Gestures, Western/Eastern Participants

```{r display_correlational_data, out.width='50%'}
all_western_correlational_data.w
all_western_correlational_data.e
```

Eastern Gestures, Western/Eastern Participants

```{r display_east_corr_dat, out.width='50%'}
all_eastern_correlational_data.w
all_eastern_correlational_data.e
```

To get the individual ones (per gesture, say) you can do this to position the w/e side by side.
```{r plot_indiv_diff_matrix, out.width='50%'}
plot1 <- plot_diff_matrix_pretty(rbind(create_difference_matrix(wg4.0.w), 
                                       create_difference_matrix(wg4.1.w), 
                                       create_difference_matrix(wg4.2.w)))

plot2 <- plot_diff_matrix_pretty(rbind(create_difference_matrix(wg4.0.e), 
                                       create_difference_matrix(wg4.1.e), 
                                       create_difference_matrix(wg4.2.e)))

plot1
plot2
```

Cool now access everything as follows:
`all_dat$overlays[["d0_overlay"]]`: the overlayed violin plot of related questions. Illustrates density overlay aka a nice vis of correlation of questions

`all_dat$correlation_matrix`: the correlation matrices that visualize the above as well.

`all_dat$violin_density_question`: the violin plot of all question distributions across gesture conditions.

`all_dat$violin_density_grouped_overlay`: the violin plot of all question distributions across gesture conditions, but overlayed.

`all_dat$violin_density_grouped`: the violin plot of group distributions across gesture conditions.

`all_dat$density_grouped`: density plot of group distributions across gesture conditions.

`all_dat$density_question`: density plot of all question distributions across gesture conditions.

if you want to plot all of the overlays nicely you can do this:
```{r}
#p1 <- all_wg1_data$overlays[["d0_overlay"]]
#p2 <- all_wg2_data$overlays[["d1_overlay"]]
#p3 <- all_wg3_data$overlays[["d2_overlay"]]
#grid.arrange(p1, p2, p3, ncol=3)
```


## Stats
Pretty, but what does it mean? Well, to determine whether any of these differences are significant (aka, did people interpret different things from each of the different gesture conditions, which, because we, too, are people, we know they did) we need to see what the significant differences between rankings in each gesture and condition are.
```{r single_culture_anovas}
## gather the bad larries
gather_clean <- function(d, n="") {
  ret <- d %>%
    gather("metaphor_measure", "score", 1:12) %>%
    mutate(condition=n) %>%
    add_groups()
  return(ret)
}

do_anova_per_group <- function(data, g) {
  group_data <- data %>%
    filter(group==g)
  res.aov <- aov(score ~ condition, data=group_data)
  print(g)
  print(summary(res.aov))
  return(res.aov)
}

do_anova_per_data <- function(data) {
  groups <- c("openness",
              "conflict",
              "control", 
              "size",
              "certainty",
              "unity")
  
  print("==== BY GROUP ====")
  for (g in groups) {
    print(g)
    a <- do_anova_per_group(data, g)
    print(summary(a))
    print("========================")
  }
}

do_anova_per_gest <- function(d0, d1, d2) {
  d <- rbind(gather_clean(d0, "original"), 
             gather_clean(d1, "cond1"), 
             gather_clean(d2, "cond2"))
  do_anova_per_data(d)
}

do_all_anovas <- function() {
  print("!!!!UNPOLITE!!!!!")
  do_anova_per_gest(wg1.0.w, wg1.1.w, wg1.2.w)
  print(" ")
  print("!!!!ENTITY!!!!!")
  do_anova_per_gest(wg2.0.w, wg2.1.w, wg2.2.w)
  print(" ")
  print("!!!!AUDIENCE!!!!!")
  do_anova_per_gest(wg3.0.w, wg3.1.w, wg3.2.w)
  print(" ")
  print("!!!!PROTECTED!!!!!")
  do_anova_per_gest(wg4.0.w, wg4.1.w, wg4.2.w)
  print(" ")
  print("!!!!BOWL!!!!!")
  do_anova_per_gest(wg5.0.w, wg5.1.w, wg5.2.w)
}

#do_all_anovas()
```


Now get those T-Tests done DID.

```{r}
get_sig_val <- function(p) {
  if(p < 0.0005) {
    return("***")
  }
  if(p < 0.005) {
    return("**")
    }
  if(p < 0.1) {
    return("*")
  }
  return ("")
}

get_nice_things <- function(d0, d1, d2, n0="original", n1="cond1", n2="cond2") {
  d0_g_cl <- gather_clean(d0, n0) 
  d1_g_cl <- gather_clean(d1, n1) 
  d2_g_cl <- gather_clean(d2, n2)
  d_total <- rbind(d0_g_cl, d1_g_cl, d2_g_cl)
  return(d_total)
}


## Have to do this hacky bit for getting the data frame and I haven't figured out why but 
## passing the data directly just doesn't play.
do_t_test_adjusted <- function(cond1, cond2, statement, dat) {
  d <- data.frame()
  if(dat == "1") {
    d <- get_nice_things(wg1.0.w, wg1.1.w, wg1.2.w)
  }
  if(dat == "2") {
    d <- get_nice_things(wg2.0.w, wg2.1.w, wg2.2.w)
  }
  if(dat == "3") {
    d <- get_nice_things(wg3.0.w, wg3.1.w, wg3.2.w)
  }
  if(dat == "4") {
    d <- get_nice_things(wg4.0.w, wg4.1.w, wg4.2.w)
    }
  if(dat == "5") {
    d <- get_nice_things(wg5.0.w, wg5.1.w, wg5.2.w)
  }
  
  p <- as.numeric(t.test(
            get_vals(cond1, statement, d),
            get_vals(cond2, statement, d))[3])
  p_adjusted <- round(p.adjust(p, method="bonferroni", n=18), digits=5)
  return(p_adjusted)
}


do_wilcox_adjusted <- function(cond1, cond2, statement, dat) {
  d <- data.frame()
  if(dat == "1") {
    d <- get_nice_things(wg1.0.w, wg1.1.w, wg1.2.w)
  }
  if(dat == "2") {
    d <- get_nice_things(wg2.0.w, wg2.1.w, wg2.2.w)
  }
  if(dat == "3") {
    d <- get_nice_things(wg3.0.w, wg3.1.w, wg3.2.w)
  }
  if(dat == "4") {
    d <- get_nice_things(wg4.0.w, wg4.1.w, wg4.2.w)
    }
  if(dat == "5") {
    d <- get_nice_things(wg5.0.w, wg5.1.w, wg5.2.w)
  }
  
  p <- as.numeric(wilcox.test(score ~ condition, 
                              filter(d, 
                                     group==statement, 
                                     condition ==cond1|condition==cond2))[3])
  p_adjusted <- round(p.adjust(p, method="bonferroni", n=18), digits=5)
  return(p_adjusted)
}

get_vals <- function(condition_name, g, dat) {
  ret <- dat %>%
    filter(condition==condition_name) %>%
    filter(group==g)
  ret <- ret$score  
  return(ret)
}


# For some reason can't generalize this to all gestures?
make_table_per_gesture <- function(gest_name, cond1name, cond2name, dat, do_wilcox=FALSE) {
  groups <- c("openness",
            "conflict",
            "control", 
            "size",
            "certainty",
            "unity")

  group <- rep(groups, each=3)
  cond1 <- rep(c(cond1name, cond2name, "original"), 6)
  cond2 <- rep(c("original", cond1name, cond2name), 6)
  df <- data.frame(group, cond1, cond2)   
  
  if(!do_wilcox) {
    df$p <- mapply(do_t_test_adjusted, 
             as.character(df$cond1), 
             as.character(df$cond2), 
             as.character(df$group),
             dat)    
  }
  else {
    df$p <- mapply(do_wilcox_adjusted, 
             as.character(df$cond1), 
             as.character(df$cond2), 
             as.character(df$group),
             dat)  
  }

  df$sig <- mapply(get_sig_val, df$p)

  return(df)
}


wg1_sig_table <- make_table_per_gesture("unpolite", "cond1", "cond2", "1")
wg1_sig_table_wilcox <- make_table_per_gesture("unpolite", "cond1", "cond2", "1", do_wilcox=TRUE)

wg2_sig_table <- make_table_per_gesture("entity", "cond1", "cond2", "2")
wg2_sig_table_wilcox <- make_table_per_gesture("entity", "cond1", "cond2", "2", do_wilcox=TRUE)

wg3_sig_table <- make_table_per_gesture("audience", "cond1", "cond2", "3")
wg3_sig_table_wilcox <- make_table_per_gesture("audience", "cond1", "cond2", "3", do_wilcox=TRUE)

wg4_sig_table <- make_table_per_gesture("protected", "cond1", "cond2", "4")
wg4_sig_table_wilcox <- make_table_per_gesture("protected", "cond1", "cond2", "4", do_wilcox=TRUE)

wg5_sig_table <- make_table_per_gesture("bowl", "cond1", "cond2", "5")
wg5_sig_table_wilcox <- make_table_per_gesture("bowl", "cond1", "cond2", "5", do_wilcox=TRUE)



#### Do spot tests below ####
spot_test <- function(d0, d1, d2, cond1="cond1", cond2="cond2", g="openness") {
  d <- get_nice_things(d0, d1, d2)
  g1 <- d %>%
    filter(condition==cond1, group==g)
  g2 <- d %>%
    filter(condition==cond2, group==g)
  p <- t.test(g1$score, g2$score)$p.value
  p_adjusted <- round(p.adjust(p, method="bonferroni", n=18), digits=5)
  return(p_adjusted)
}


kable(filter(wg1_sig_table, sig != ""))
kable(filter(wg1_sig_table_wilcox, sig != ""))

kable(filter(wg2_sig_table, sig != ""))
kable(filter(wg2_sig_table_wilcox, sig != ""))

kable(filter(wg3_sig_table, sig != ""))
kable(filter(wg3_sig_table_wilcox, sig != ""))

kable(filter(wg4_sig_table, sig != ""))
kable(filter(wg4_sig_table_wilcox, sig != ""))

kable(filter(wg5_sig_table, sig != ""))
kable(filter(wg5_sig_table_wilcox, sig != ""))


# for example:
#spot_test(wg1.0.w, wg1.1.w, wg1.2.w, "original", "cond2", "conflict")
```
The above shows that t tests and mann-whitney-wilcox have the same significance results.

## Individual Response Patterns tho
Cool so we have all this but what do *individuals* actually perceive -- multiple interpretations, or one predominant one? Only likert will tell us. 

Let's do this with a **PIE CHART** BAYBEEEEE

-- highly is top 3 for ranked
-- highly is 5,6,7 for likert
- people who ranked X & Y highly 
- people who ranked X highly (but not Y)
- people who ranked Y highly (but not X)
- people who did neither
```{r individual_bucket_pie_charts}
##  group      value (count)
##  X + Y   
##  X
##  Y
##  neither


## Get data for this pie chart. Double since we're adding to 14 here
likert_upper_cutoff <- 10


get_pie_data <- function(dat, group1, group2) {
  ## this requires a whole new analysis of data of individuals...
  indiv_dat <- dat %>%
    mutate(conflict = Answer.conflict + Answer.tension, 
           openness = Answer.open + Answer.accessible,
           unity = Answer.goal + Answer.worktogether,
           certainty = Answer.confident + Answer.sure,
           control = Answer.dominant + Answer.control,
           size = Answer.many + Answer.members) %>%
    select(conflict, openness, unity, certainty, control, size)
  
  # get value then convert to percentages
  g1_high <- sum(indiv_dat[group1] >= 10 & indiv_dat[group2] < 10)
  g2_high <- sum(indiv_dat[group2] >= 10 & indiv_dat[group1] < 10)
  both_high <- sum(indiv_dat[group2] >= 10 & indiv_dat[group1] >= 10)
  neither_high <- sum(indiv_dat[group2] < 10 & indiv_dat[group1] < 10)
  
  g1_high <- (g1_high / nrow(indiv_dat)) 
  g2_high <- (g2_high / nrow(indiv_dat)) 
  both_high <- (both_high / nrow(indiv_dat)) 
  neither_high <- (neither_high / nrow(indiv_dat))
  
  
  df <- data.frame(
    group = c("both", group1, "neither", group2),
    value = c(both_high, g1_high, neither_high, g2_high)
  )
  
  return(df)
}

make_pie_chart <- function(dat, group1, group2, gesture_name, cond) {
  blank_theme <- theme_minimal() +
      theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_blank(),
        panel.grid=element_blank(),
        axis.ticks = element_blank(),
        plot.title=element_text(size=7, face="bold")
      )

  pie <- ggplot(dat, aes(x="", y=value, fill=group))+
    geom_bar(width = 1, stat = "identity") + 
    coord_polar("y", start=0)+  blank_theme +
    theme(axis.text.x=element_blank()) +
    geom_text(aes(label = paste0(round(value*100), "%")), position = position_stack(vjust = 0.5)) +
    ggtitle(paste("comp.", gesture_name, cond," -- ", group1, "//", group2))
  return(pie)
}


p_maker <- function(dat, g1, g2, c1, c2) {
  p <- make_pie_chart(get_pie_data(dat, g1, g2), "likert", paste(g1, g2, sep="/"), c1, c2)
}

p_wg1.0.w <- p_maker(wg1.0.w, "conflict", "unity", "unpolite", "original")
p_wg1.1.w <- p_maker(wg1.1.w, "conflict", "unity", "unpolite", "intertwine")
p_wg1.2.w <- p_maker(wg1.2.w, "conflict", "unity", "unpolite", "collide")
p_wg2.0.w <- p_maker(wg2.0.w, "control", "openness", "entity", "original")
p_wg2.1.w <- p_maker(wg2.1.w, "control", "openness", "entity", "open")
p_wg2.2.w <- p_maker(wg2.2.w, "control", "openness", "entity", "chest")
p_wg3.0.w <- p_maker(wg3.0.w, "openness", "unity", "audience", "original")
p_wg3.1.w <- p_maker(wg3.1.w, "openness", "unity", "audience", "down")
p_wg3.2.w <- p_maker(wg3.2.w, "openness", "unity", "audience", "open")
p_wg4.0.w <- p_maker(wg4.0.w, "size", "control", "anything", "original")
p_wg4.1.w <- p_maker(wg4.1.w, "size", "control", "anything", "frame")
p_wg4.2.w <- p_maker(wg4.2.w, "size", "control", "anything", "surface")
p_wg5.0.w <- p_maker(wg5.0.w, "certainty", "unity", "specific", "original")
p_wg5.1.w <- p_maker(wg5.1.w, "certainty", "unity", "specific", "bowl")
p_wg5.2.w <- p_maker(wg5.2.w, "certainty", "unity", "specific", "forward")
p_wg1.0.e <- p_maker(wg1.0.e, "conflict", "unity", "unpolite", "original")
p_wg1.1.e <- p_maker(wg1.1.e, "conflict", "unity", "unpolite", "intertwine")
p_wg1.2.e <- p_maker(wg1.2.e, "conflict", "unity", "unpolite", "collide")

```

```{r wg_wp_only}
all_wg1_data$violin_density_grouped_overlay
grid.arrange(p_wg1.0.w, p_wg1.1.w, p_wg1.2.w, ncol=3)
all_wg2_data$violin_density_grouped_overlay
grid.arrange(p_wg2.0.w, p_wg2.1.w, p_wg2.2.w, ncol=3)
all_wg3_data$violin_density_grouped_overlay
grid.arrange(p_wg3.0.w, p_wg3.1.w, p_wg3.2.w, ncol=3)
all_wg4_data$violin_density_grouped_overlay
grid.arrange(p_wg4.0.w, p_wg4.1.w, p_wg4.2.w, ncol=3)
all_wg5_data$violin_density_grouped_overlay
grid.arrange(p_wg5.0.w, p_wg5.1.w, p_wg5.2.w, ncol=3)
```


and now for comparing western and eastern:
```{r}
grid.arrange(p_wg1.0.w, p_wg1.0.e, 
             p_wg1.1.w, p_wg1.1.e,
             p_wg1.2.w, p_wg1.2.e, 
             ncol=2)
```


## this is just messy
```{r}
## let's say ranking 1,2,3

## oh shit let's pull in the ranking data. 
uo <- read.csv('../../IVA2019-data-and-examples/uo_individuals.csv')
ut <- read.csv('../../IVA2019-data-and-examples/ut_individuals.csv')
uf <- read.csv('../../IVA2019-data-and-examples/uf_individuals.csv')

## now just massage it so it looks nicer...
clean_ranking_dat <- function(dat) {
  dat <- dat[-1,]
  dat <- dat %>%
  select(Please.order.these.questions.from.most..first..to.least..last..true., 
         X,
         X.1,
         X.2,
         X.3,
         X.4,
         X.5,
         X.6,
         X.7,
         X.8) 
  n <- c("worktogether", "everybody", "tension", "disagree", "many", 
             "getalong", "likes", "annoyed", "control", "feedback")
  names(dat) <- n
  dat <- dat[!apply(dat, 1, function(x) any(x=="")),]
  dat$worktogether <- as.numeric(as.character(dat$worktogether))
  dat$tension <- as.numeric(as.character(dat$tension))
  dat$disagree <- as.numeric(as.character(dat$disagree))
  dat$getalong <- as.numeric(as.character(dat$getalong))
  return(dat)
}

group_ranking_dat <- function(dat) {
  d <- dat %>%
    mutate(conflict_high = (tension <= 3 | disagree <= 3),
           unity_high = (worktogether <= 3 | getalong <= 3))
}

get_pie_data_ranked <- function(dat) {
  both_high <- sum(dat$conflict_high & dat$unity_high)
  g1_high <- sum(dat$conflict_high & !dat$unity_high)
  g2_high <- sum(!dat$conflict_high & dat$unity_high)
  neither_high <- sum(!dat$conflict_high & !dat$unity_high)
  
  df <- data.frame(
    group = c("both", "conflict", "unity", "neither"),
    value = c(both_high, g1_high, g2_high, neither_high)
  )
  
  return(df)
}

prep_ranked_for_pie <- function(dat) {
  d_indiv_clean <- clean_ranking_dat(dat)
  d_grouped <- group_ranking_dat(d_indiv_clean)
  pie_dat <- get_pie_data_ranked(d_grouped)
  return(pie_dat)
}

p_uo_ranked <- prep_ranked_for_pie(uo)
p_ut_ranked <- prep_ranked_for_pie(ut)
p_uf_ranked <- prep_ranked_for_pie(uf)

p_wg1.0_ranked <- make_pie_chart(p_uo_ranked, "ranked", "conflict/unity", "unpolite", "original")
p_wg1.1_ranked <- make_pie_chart(p_ut_ranked, "ranked", "conflict/unity", "unpolite", "intertwine")
p_wg1.2_ranked <- make_pie_chart(p_uf_ranked, "ranked", "conflict/unity", "unpolite", "collide")
```

So here are our ranked ones
```{r}
grid.arrange(p_wg1.0.w, p_wg1.0_ranked, p_wg1.1.w, p_wg1.1_ranked, p_wg1.2.w, p_wg1.2_ranked, nrow=3, ncol=2)
```






# PART TWO: BICULTURALISM AT ITS FINEST

## Wrangle these bad larries
```{r}
wrangle_mini <- function(d, cond="data", culture="western") {
  gathered <- gather_select(d)
  grouped <- add_groups(gathered)
  grouped$condition <- cond
  grouped$viewer_culture <- culture
  return(grouped)
}

create_total_bicultural_tables <- function(wd0, wd1, wd2, ed0, ed1, ed2, cond1="cond1", cond2="cond2") {
  d0_w <- wrangle_mini(wd0, "original", "western")
  d1_w <- wrangle_mini(wd1, cond1, "western")
  d2_w <- wrangle_mini(wd2, cond2, "western")
  d0_e <- wrangle_mini(ed0, "original", "eastern")
  d1_e <- wrangle_mini(ed1, cond1, "eastern")
  d2_e <- wrangle_mini(ed2, cond2, "eastern")
  
  total <- rbind(d0_w, d1_w, d2_w, d0_e, d1_e, d2_e) 
}

## Pretending that wg4 is our eastern viewers for wg1
## when we actually do it it'll be wg1.0.w, wg1.1.w, wg1.2.w, wg1.0.e, wg1.1.e, wg1.2.e
wg1_total <- create_total_bicultural_tables(wg1.0.w, wg1.1.w, wg1.2.w, wg1.0.e, wg1.1.e, wg1.2.e, "cond1", "cond2")
### could put this all in a loop but writing it out isn't so bad and it helps me see just how much data we have.
#Uncomment for a good time [[once we have the bi-cultural data]]
wg2_total <- create_total_bicultural_tables(wg2.0.w, wg2.1.w, wg2.2.w, wg2.0.e, wg2.1.e, wg2.2.e, "cond1", "cond2")
wg3_total <- create_total_bicultural_tables(wg3.0.w, wg3.1.w, wg3.2.w, wg3.0.e, wg3.1.e, wg3.2.e, "cond1", "cond2")
wg4_total <- create_total_bicultural_tables(wg4.0.w, wg4.1.w, wg4.2.w, wg4.0.e, wg4.1.e, wg4.2.e, "cond1", "cond2")
wg5_total <- create_total_bicultural_tables(wg5.0.w, wg5.1.w, wg5.2.w, wg5.0.e, wg5.1.e, wg5.2.e, "cond1", "cond2")

eg1_total <- create_total_bicultural_tables(eg1.0.w, eg1.1.w, eg1.2.w, eg1.0.e, eg1.1.e, eg1.2.e, "cond1", "cond2")
eg2_total <- create_total_bicultural_tables(eg2.0.w, eg2.1.w, eg2.2.w, eg2.0.e, eg2.1.e, eg2.2.e, "cond1", "cond2")
eg3_total <- create_total_bicultural_tables(eg3.0.w, eg3.1.w, eg3.2.w, eg3.0.e, eg3.1.e, eg3.2.e, "cond1", "cond2")
eg4_total <- create_total_bicultural_tables(eg4.0.w, eg4.1.w, eg4.2.w, eg4.0.e, eg4.1.e, eg4.2.e, "cond1", "cond2")
# eg5_total <- create_total_bicultural_tables(eg5.0.w, eg5.1.w, eg5.2.w, eg5.0.e, eg5.1.e, eg5.2.e, "cond1", "cond2")


discretize_score <- function(data) {
  d <- data %>%
    mutate("score_grouping", )
}
```

cool now we have all that data in one place. We need to compare the western and eastern viewers across conditions. 

## Plot these bad larries.
Easy enough to do stats on means between cultures but baby I wanna see those VIOLIN PLOTSSSSSS.

Can only plot by one thing at a time (i.e. for a single gesture condition then visualize across 
metaphor measures, or for a single metaphor measure then visualize across conditions. The second doesn't make sense though....)
```{r}
median.quartile <- function(x){
  out <- quantile(x, probs = c(0.25,0.5,0.75))
  names(out) <- c("ymin","y","ymax")
  return(out) 
}

violin_compare_cultures_across_meta_groups <- function(data, cond="original", gesture_name="unknown") {
  g <- ggplot(filter(data)) + 
    aes(x=condition,y=score,fill=viewer_culture, position="dodge") +
    geom_violin(alpha=0.4,position="dodge", adjust=1, draw_quantiles=c(0.25, 0.5, 0.75)) +
    scale_fill_manual(values=c("palevioletred3", "steelblue3")) +
    facet_wrap("group") +
    # geom_boxplot(position="dodge", alpha=0.8, width=0.1) +
    geom_jitter(shape=16, alpha=1, position=position_jitterdodge(jitter.width=0.3, jitter.height=0.3), aes(alpha=1, color=viewer_culture)) +
    labs(
      title = paste("Comparison across cultures for", gesture_name, " -- ", cond, "Condition")
    ) 
  return(g)
}

violin_prep_data_get_plot <- function(data, cond="original", gesture_name="unknown") {
  g <- violin_compare_cultures_across_meta_groups(data, cond, gesture_name)
  return(g)
}

get_violin_comparisons_per_gesture <- function(dat, cond1="cond1", cond2="cond2", gesture_name="unknown") {
  c0 <- violin_prep_data_get_plot(dat, "original", gesture_name)
  return_list <- list("c0_violin_comparison"=c0)
}

t <- get_violin_comparisons_per_gesture(wg1_total, "cond1", "cond2", "wg1")

wg1_violin_culture_comparisons <- get_violin_comparisons_per_gesture(wg1_total, "cond1", "cond2", "wg1")
wg2_violin_culture_comparisons <- get_violin_comparisons_per_gesture(wg2_total, "cond1", "cond2", "wg2")
wg3_violin_culture_comparisons <- get_violin_comparisons_per_gesture(wg3_total, "cond1", "cond2", "wg3")
wg4_violin_culture_comparisons <- get_violin_comparisons_per_gesture(wg4_total, "cond1", "cond2", "wg4")
wg5_violin_culture_comparisons <- get_violin_comparisons_per_gesture(wg5_total, "cond1", "cond2", "wg5")

eg1_violin_culture_comparisons <- get_violin_comparisons_per_gesture(eg1_total, "cond1", "cond2", "eg1")
eg2_violin_culture_comparisons <- get_violin_comparisons_per_gesture(eg2_total, "cond1", "cond2", "eg2")
eg3_violin_culture_comparisons <- get_violin_comparisons_per_gesture(eg3_total, "cond1", "cond2", "eg3")
eg4_violin_culture_comparisons <- get_violin_comparisons_per_gesture(eg4_total, "cond1", "cond2", "eg4")
#eg5_violin_culture_comparisons <- get_violin_comparisons_per_gesture(eg5_total, "cond1", "cond2", "eg5")
```
Now the plots live in things like `wg1_violin_culture_comparisons$c0_violin_comparison`

Cool now across I actually don't think the other comparison makes sense because you're comparing things across different gestures which defeats the purpose of the visualizations. 

So anyway, 

### Stats
Could do ANOVAs but it doesn't necessarily make sense since we're just comparing two groups.
```{r echo = FALSE}
bi_culture_t_test <- function(g1, g2) {
  p <- t.test(g1, g2)[3]$p.value
  p <- round(p.adjust(p, method="bonferroni", n=12), digits=5)
  return(p)
}

# data comes in as already filtered out by gesture/condition
make_table_per_gesturecondition_by_culture <- function(dat) {
  groups <- c("openness",
            "conflict",
            "control", 
            "size",
            "certainty",
            "unity")
  western_mean <- c()
  eastern_mean <- c()
  p <- c()
  sig <- c()
  ## it's not tricky or pretty but it's readable so get off my back, R coding purist h8rs
  for(g in groups) {
    w_only <- dat %>%
      filter(viewer_culture=="western", group==g)
    e_only <- dat %>%
      filter(viewer_culture=="eastern", group==g)
    
    western_mean <- append(western_mean, mean(w_only$score))
    eastern_mean <- append(eastern_mean, mean(e_only$score))
    p_v <- bi_culture_t_test(w_only$score, e_only$score)
    p <- append(p, p_v)
    sig <- append(sig,
                  get_sig_val(p_v))
  }

  df <- data.frame(groups, western_mean, eastern_mean, p, sig)   
  return(df)
} 


do_t_culture_groups <- function(dat, cond1="cond1", cond2="cond2", gesture_name="unknown") {
  c0 <- make_table_per_gesturecondition_by_culture(filter(dat, condition=="original"))
  c1 <- make_table_per_gesturecondition_by_culture(filter(dat, condition==cond1))
  c2 <- make_table_per_gesturecondition_by_culture(filter(dat, condition==cond2))
  
  return_list <- list("c0_comparison"=c0, 
                      "c1_comparison"=c1,
                      "c2_comparison"=c2)
}

wg1_total_cultural_comparison_tables <- do_t_culture_groups(wg1_total, "cond1", "cond2", "wg1")
wg2_total_cultural_comparison_tables <- do_t_culture_groups(wg2_total, "cond1", "cond2", "wg2")
wg3_total_cultural_comparison_tables <- do_t_culture_groups(wg3_total, "cond1", "cond2", "wg3")
wg4_total_cultural_comparison_tables <- do_t_culture_groups(wg4_total, "cond1", "cond2", "wg4")
wg5_total_cultural_comparison_tables <- do_t_culture_groups(wg5_total, "cond1", "cond2", "wg5")
# 
eg1_total_cultural_comparison_tables <- do_t_culture_groups(eg1_total, "cond1", "cond2", "eg1")
eg2_total_cultural_comparison_tables <- do_t_culture_groups(eg2_total, "cond1", "cond2", "eg2")
eg3_total_cultural_comparison_tables <- do_t_culture_groups(eg3_total, "cond1", "cond2", "eg3")
eg4_total_cultural_comparison_tables <- do_t_culture_groups(eg4_total, "cond1", "cond2", "eg4")
#eg5_total_cultural_comparison_tables <- do_t_culture_groups(eg5_total, "cond1", "cond2", "eg5")

```
Now all that data lives in things like `wg1_total_cultural_comparison_tables$c0_comparison`
that look like this:
WG1-0 (this name isn't here in the actual version, we just know from the naming scheme)


```{r save everything, include=FALSE}
# Western
ggsave("wg1_violin_jitter.png", plot=wg1_violin_culture_comparisons$c0_violin_comparison)
ggsave("wg2_violin_jitter.png", plot=wg2_violin_culture_comparisons$c0_violin_comparison)
ggsave("wg3_violin_jitter.png", plot=wg3_violin_culture_comparisons$c0_violin_comparison)
ggsave("wg4_violin_jitter.png", plot=wg4_violin_culture_comparisons$c0_violin_comparison)
ggsave("wg5_violin_jitter.png", plot=wg5_violin_culture_comparisons$c0_violin_comparison)
# Eastern
ggsave("eg1_violin_jitter.png", plot=eg1_violin_culture_comparisons$c0_violin_comparison)
ggsave("eg2_violin_jitter.png", plot=eg2_violin_culture_comparisons$c0_violin_comparison)
ggsave("eg3_violin_jitter.png", plot=eg3_violin_culture_comparisons$c0_violin_comparison)
ggsave("eg4_violin_jitter.png", plot=eg4_violin_culture_comparisons$c0_violin_comparison)
```

### WG1
```{r, out.width='50%'}
kable(wg1_total_cultural_comparison_tables$c0_comparison)
kable(wg1_total_cultural_comparison_tables$c1_comparison)
kable(wg1_total_cultural_comparison_tables$c2_comparison)
knitr::include_graphics("wg1_violin_jitter.png")
```

### WG2
```{r, out.width='50%'}
kable(wg2_total_cultural_comparison_tables$c0_comparison)
kable(wg2_total_cultural_comparison_tables$c1_comparison)
kable(wg2_total_cultural_comparison_tables$c2_comparison)
knitr::include_graphics("wg2_violin_jitter.png")
```

### WG3
```{r, out.width='50%'}
kable(wg3_total_cultural_comparison_tables$c0_comparison)
kable(wg3_total_cultural_comparison_tables$c1_comparison)
kable(wg3_total_cultural_comparison_tables$c2_comparison)
knitr::include_graphics("wg3_violin_jitter.png")
```

### WG4
```{r, out.width='50%'}
kable(wg4_total_cultural_comparison_tables$c0_comparison)
kable(wg4_total_cultural_comparison_tables$c1_comparison)
kable(wg4_total_cultural_comparison_tables$c2_comparison)
knitr::include_graphics("wg4_violin_jitter.png")
```

### WG5
```{r, out.width='50%'}
kable(wg5_total_cultural_comparison_tables$c0_comparison)
kable(wg5_total_cultural_comparison_tables$c1_comparison)
kable(wg5_total_cultural_comparison_tables$c2_comparison)
knitr::include_graphics("wg5_violin_jitter.png")
```


### EG1
```{r, out.width='50%'}
kable(eg1_total_cultural_comparison_tables$c0_comparison)
kable(eg1_total_cultural_comparison_tables$c1_comparison)
kable(eg1_total_cultural_comparison_tables$c2_comparison)
knitr::include_graphics("eg1_violin_jitter.png")
```

### EG2
```{r, out.width='50%'}
kable(eg2_total_cultural_comparison_tables$c0_comparison)
kable(eg2_total_cultural_comparison_tables$c1_comparison)
kable(eg2_total_cultural_comparison_tables$c2_comparison)
knitr::include_graphics("eg2_violin_jitter.png")
```

### EG3
```{r, out.width='50%'}
kable(eg3_total_cultural_comparison_tables$c0_comparison)
kable(eg3_total_cultural_comparison_tables$c1_comparison)
kable(eg3_total_cultural_comparison_tables$c2_comparison)
knitr::include_graphics("eg3_violin_jitter.png")
```

### EG4
```{r eg4_violin_comparisons, out.width='50%'}
kable(eg4_total_cultural_comparison_tables$c0_comparison)
kable(eg4_total_cultural_comparison_tables$c1_comparison)
kable(eg4_total_cultural_comparison_tables$c2_comparison)
knitr::include_graphics("eg4_violin_jitter.png")
```


### Are these powers good enough?
Quick spot check...
```{r power_check}
get_effect_size <- function(vec1, vec2) {
  u1 <- mean(vec1)
  u2 <- mean(vec2)
  sd_pooled <- sqrt((sd(vec1) ** 2) + (sd(vec2) ** 2) / 2)
  return((u1 - u2) / sd_pooled)
}

calculate_power_for_condition <- function(gesture_data, metaphor, cond) {
  t1.w <- filter(gesture_data, viewer_culture == "western") %>%
    filter(group == metaphor) %>%
    filter(condition == cond)
  
  t1.e <- filter(gesture_data, viewer_culture == "eastern") %>%
    filter(group == metaphor) %>%
    filter(condition == cond)
  
  d <- get_effect_size(t1.w$score, t1.e$score)  
  power <- pwr.t2n.test(n1 = length(t1.w$score), n2 = length(t1.e$score), d, sig.level = 0.05)
  return(power)
}
```

Short Answer: yes because we grouped so n = 2n lol. Interestingly, only for the significant differences do we see powers > 0.8. I mean not *that* interestingly cause like that's how effect size works but still. Anyway, power is definitely high enough.

Example usage:
```{r echo = TRUE}
cond_power <- calculate_power_for_condition(wg2_total, "conflict", "original")
```
Then you get a variable called `cond_power` you can use to see the actual power through `cond_power$power`. 
In this case our power is `r cond_power$power`




### Analyzing with high/med/low
```{r pie_buckets_indiv}
wg1_bucket_scores <- wg1_total %>% 
    mutate(score_bucket = ifelse(score %in% 5:7, "chigh", 
                          ifelse(score %in% 3:4, "bmed",
                          ifelse(score %in% 1:2, "alow", "NA"))))

make_pie_bucket_scores <- function(dat, group1, group2, gesture_name, cond) {
  blank_theme <- theme_minimal() +
      theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_blank(),
        panel.grid=element_blank(),
        axis.ticks = element_blank(),
        plot.title=element_text(size=7, face="bold")
      )

  pie <- ggplot(dat, aes(x="", y=value, fill=score_bucket))+
    geom_bar(width = 1, stat = "identity") + 
    coord_polar("y", start=0)+  blank_theme +
    theme(axis.text.x=element_blank()) +
    geom_text(aes(label = paste0(round(value*100), "%")), position = position_stack(vjust = 0.5)) +
    ggtitle(paste("comp.", gesture_name, cond," -- ", group1, "//", group2))
  return(pie)
}

```

```{r old_dotplot}
## 21/8/19 my god this is so quick and dirty I am deeply ashamed.
## 22/8/19 also it doesn't work right now
## 29/8/19 abandoned this line of analysis

# t <- filter(wg1_bucket_scores, viewer_culture=="western", group=="conflict")

# a <- sum(t$score_bucket == "ahigh") / nrow(t) 
# b <- sum(t$score_bucket == "bmed") / nrow(t)
# c <- sum(t$score_bucket == "clow") / nrow(t)
# 
# bucket <- c("high", "med", "low")
# value <- c(a,b,c)
# 
# df <- data.frame(bucket, value)
# 
# wg1_bucket_scores$score_bucket <- as.factor(wg1_bucket_scores$score_bucket)
# wg1_bucket_scores$condition <- as.factor(wg1_bucket_scores$condition)
# 
# ggplot(wg1_bucket_scores, aes(x=condition, y=score_bucket, fill=viewer_culture))+
#     geom_dotplot(stackdir="center", dotsize=0.3, binwidth = 0.1)

```



## Now analyze high/med/low
```{r shitshow_of_bucketing_cultural_data}
bucket_culture_scores <- function(dat) {
  d <- dat %>%
    mutate(score_bucket = ifelse(score >= 6, "ahigh", ifelse(score <= 2, "clow", "bmedium")))
  return(d)
}


get_bucket_values <- function(d) {
  # this is so hacky it's absoultely gross.
  lmh_vals <- c(0,0,0)
  for(row in 1:nrow(d)) {
    if(d[row, 'score_bucket'] == "clow") {
        lmh_vals[1] <- d[row, 'count_bucket']
    } else if(d[row, 'score_bucket'] == "bmedium") {
        lmh_vals[2] <- d[row, 'count_bucket']
    } else if(d[row, 'score_bucket'] == "ahigh") {
        lmh_vals[3] <- d[row, 'count_bucket']
    }
    if(!(0 %in% lmh_vals)) {
      return(lmh_vals)  # return as soon as you can
    }
  }
  # in case there were never any instances of it
  return(lmh_vals)
}

## there is a bug in this analysis
# it currently calculates the y axis (bucket_percent) by calculating percentage of 
# ALL groups, not just for the individual culture. It needs to be individual by culture
# because the groups don't have the same number of participants so results will be 
# skewed if it's not.
get_bucketed_data <- function(dat) {
  groups = c("unity", "conflict", "openness", "control", "size", "certainty")
  cultures = c("western", "eastern") # have to do it by culture because otherwise 
  # we will be counting percentages of total conditions which won't work because the 
  # groups are unequally sized.
  conditions = c("original", "cond1", "cond2") # this is just cause I can't figure out
                                               # how tf groupby works.
  dfs = vector(mode="list", length=6)
  i = 1
  for(c in cultures) {
    for(g in groups) {
      d <- bucket_culture_scores(dat) %>%
          filter(group==g, viewer_culture==c)
      for(co in conditions) {
         dc <- d %>%
           filter(condition==co) %>%
           mutate(count_bucket = ifelse(score_bucket=="ahigh", sum(score_bucket=="ahigh"), 
                                ifelse(score_bucket=="bmedium", sum(score_bucket=="bmedium"), 
                                       sum(score_bucket=="clow")))) 
         total_participants_per_condition <- sum(get_bucket_values(dc))
         dcf <- dc %>%
           mutate(bucket_percent = count_bucket / total_participants_per_condition) %>%
           mutate(culture_bucket = paste(score_bucket, viewer_culture, sep="_")) 
        dfs[[i]] <- dcf
        i = i + 1 
      }
    }
  }
  full_dat <- bind_rows(dfs, .id = "column_label") 
  full_dat[is.na(full_dat)] <- 0
  return(full_dat)
}


create_bucketed_bar_chart <- function(dat, gest) {
  d <- get_bucketed_data(dat)
  p <- ggplot(d,aes(x=condition,y=bucket_percent,fill=factor(culture_bucket)))+
    geom_bar(stat="identity",position="dodge")+
    scale_fill_manual("legend", values=c("ahigh_eastern" = "palegreen3",  # rosybrown1, 3, 4
                                         "bmedium_eastern" = "steelblue2",
                                         "clow_eastern" = "palevioletred2",
                                         "ahigh_western" = "palegreen4", # steelblue1, 3, 4
                                         "bmedium_western" = "steelblue4",
                                         "clow_western" = "palevioletred4")) +
    xlab("Gesture Condition")+ylab("Score bucket as proportional to total scores")+
    ggtitle(paste("Bucketed scores for", gest, sep=" ")) + 
    facet_wrap("group")
  return(p)
}

t2 <- get_bucketed_data(eg2_total)

wg1_comp <- create_bucketed_bar_chart(wg1_total, "WG1")
wg2_comp <- create_bucketed_bar_chart(wg2_total, "WG2")
wg3_comp <- create_bucketed_bar_chart(wg3_total, "WG3")
wg4_comp <- create_bucketed_bar_chart(wg4_total, "WG4")
wg5_comp <- create_bucketed_bar_chart(wg5_total, "WG5")

eg1_comp <- create_bucketed_bar_chart(eg1_total, "EG1")
eg2_comp <- create_bucketed_bar_chart(eg2_total, "EG2")
eg3_comp <- create_bucketed_bar_chart(eg3_total, "EG3")
eg4_comp <- create_bucketed_bar_chart(eg4_total, "EG4")


get_summary_stats <- function(dat) {
  t <- get_bucketed_data(dat) %>%
    select(group, condition, viewer_culture, score_bucket, count_bucket) %>%
    group_by(condition, group, viewer_culture) %>%
    unique() %>%
    spread(score_bucket, count_bucket)
  
  sum_stats <- get_bucketed_data(dat) %>%
    group_by(condition, group, viewer_culture) %>%
    summarise(sd=sd(score), avg=mean(score))
  
  tt <- right_join(t, sum_stats, by=c("group", "viewer_culture", "condition"))
  tt[is.na(tt)] <- 0
  return(tt)
}

wg1_summary_stats <- get_summary_stats(wg1_total)
wg2_summary_stats <- get_summary_stats(wg2_total)
wg3_summary_stats <- get_summary_stats(wg3_total)
wg4_summary_stats <- get_summary_stats(wg4_total)
wg5_summary_stats <- get_summary_stats(wg5_total)

eg1_summary_stats <- get_summary_stats(eg1_total)
eg2_summary_stats <- get_summary_stats(eg2_total)
eg3_summary_stats <- get_summary_stats(eg3_total)
eg4_summary_stats <- get_summary_stats(eg4_total)
```

### Do some STATS on these puppies.
1. Tell if proportion between groups are sig.
```{r calculate_bucket_stats, include=FALSE}
test_bucketed_significance <- function(dat) {
  #new_col_names <- c("condition", "group", "high_comp", "med_comp", "low_comp")
  #names(newdf) <- new_col_names
  condition <- c()
  group <- c()
  high_comp <- c()
  adjusted_high_comp <- c()
  med_comp <- c()
  adjusted_med_comp <- c()
  low_comp <- c()
  adjusted_low_comp <- c()
  groups <- c("certainty", "conflict", "control", "unity", "openness", "size")
  cs <- c("cond1", "cond2", "original")
  c1 <- dat %>%
    filter(condition=="cond1")
  c2 <- dat %>%
    filter(condition=="cond2")
  c0 <- dat %>%
    filter(condition=="original")
  for(c in cs) { 
    c_dat <- dat %>%
      filter(condition==c)
    for(g in groups) {
      g_dat <- c_dat %>%
        filter(group==g)
      w <- g_dat %>%
        filter(viewer_culture=="western")
      e <- g_dat %>%
        filter(viewer_culture=="eastern")
      wsum <- w$ahigh + w$bmedium + w$clow
      esum <- e$ahigh + e$bmedium + e$clow
      z.test.high <- prop.test(x=c(w$ahigh, e$ahigh), n=c(wsum, esum))
      z.test.med <- prop.test(x=c(w$bmedium, e$bmedium), n=c(wsum, esum))
      z.test.low <- prop.test(x=c(w$clow, e$clow), n=c(wsum, esum))
      condition <- list.append(condition, c)
      group <- list.append(group, g)
      high_comp <- list.append(high_comp, paste(round(z.test.high$p.value, digits=4), get_sig(z.test.high$p.value), sep=" "))
      adjusted_high_comp <- list.append(adjusted_high_comp, get_sig(p.adjust(z.test.high$p.value, method="bonferroni", n=3)))
      med_comp <- list.append(med_comp, paste(round(z.test.med$p.value, digits=4), get_sig(z.test.med$p.value), sep=" "))
      adjusted_med_comp <- list.append(adjusted_med_comp, get_sig(p.adjust(z.test.med$p.value, method="bonferroni", n=3)))
      low_comp <- list.append(low_comp, paste(round(z.test.low$p.value, digits=4), get_sig(z.test.low$p.value), sep=" "))
      adjusted_low_comp <- list.append(adjusted_low_comp, get_sig(p.adjust(z.test.low$p.value, method="bonferroni", n=3)))
    } 
  }
  df <- data.frame(condition, group, high_comp, adjusted_high_comp, med_comp, adjusted_med_comp, low_comp, adjusted_low_comp) %>%
    group_by(group)
  return(df)
}

get_sig <- function(val) {
  sig <- ""
  if(val <= 0.0005) {
    sig <- "***"
  }
  else if(val <= 0.005) {
    sig <- "**"
  }
  else if(val <= 0.05) {
    sig <- "*"
  }
  return(sig)
}

wg1_difference_table <- test_bucketed_significance(wg1_summary_stats)
wg2_difference_table <- test_bucketed_significance(wg2_summary_stats)
wg3_difference_table <- test_bucketed_significance(wg3_summary_stats)
wg4_difference_table <- test_bucketed_significance(wg4_summary_stats)
wg5_difference_table <- test_bucketed_significance(wg5_summary_stats)

eg1_difference_table <- test_bucketed_significance(eg1_summary_stats)
eg2_difference_table <- test_bucketed_significance(eg2_summary_stats)
eg3_difference_table <- test_bucketed_significance(eg3_summary_stats)
eg4_difference_table <- test_bucketed_significance(eg4_summary_stats)
```

Display these bad puppies now
```{r display_cultural_bucket_bars}
knitr::include_graphics("../gesture_imgs/wg1-0.png")
knitr::include_graphics("../gesture_imgs/wg1-1.png")
knitr::include_graphics("../gesture_imgs/wg1-2.png")
ggsave("wg1-barcomp.png", plot=wg1_comp)
knitr::include_graphics("wg1-barcomp.png")
kable(wg1_difference_table)
kable(wg1_summary_stats)

knitr::include_graphics("../gesture_imgs/wg2-0.png")
knitr::include_graphics("../gesture_imgs/wg2-1.png")
knitr::include_graphics("../gesture_imgs/wg2-2.png")
ggsave("wg2-barcomp.png", plot=wg2_comp)
knitr::include_graphics("wg2-barcomp.png")
kable(wg2_difference_table)
kable(wg2_summary_stats)

knitr::include_graphics("../gesture_imgs/wg3-0.png")
knitr::include_graphics("../gesture_imgs/wg3-1.png")
knitr::include_graphics("../gesture_imgs/wg3-2.png")
ggsave("wg3-barcomp.png", plot=wg3_comp)
knitr::include_graphics("wg3-barcomp.png")
kable(wg3_difference_table)
kable(wg3_summary_stats)

knitr::include_graphics("../gesture_imgs/wg4-0.png")
knitr::include_graphics("../gesture_imgs/wg4-1.png")
knitr::include_graphics("../gesture_imgs/wg4-2.png")
ggsave("wg4-barcomp.png", plot=wg4_comp)
knitr::include_graphics("wg4-barcomp.png")
kable(wg4_difference_table)
kable(wg4_summary_stats)

knitr::include_graphics("../gesture_imgs/wg5-0.png")
knitr::include_graphics("../gesture_imgs/wg5-1.png")
knitr::include_graphics("../gesture_imgs/wg5-2.png")
ggsave("wg5-barcomp.png", plot=wg5_comp)
knitr::include_graphics("wg5-barcomp.png")
kable(wg5_difference_table)
kable(wg5_summary_stats)

## EAST
knitr::include_graphics("../gesture_imgs/eg1-0.png")
knitr::include_graphics("../gesture_imgs/eg1-1.png")
knitr::include_graphics("../gesture_imgs/eg1-2.png")
ggsave("eg1-barcomp.png", plot=eg1_comp)
knitr::include_graphics("eg1-barcomp.png")
kable(eg1_difference_table)
kable(eg1_summary_stats)

knitr::include_graphics("../gesture_imgs/eg2-0.png")
knitr::include_graphics("../gesture_imgs/eg2-1.png")
knitr::include_graphics("../gesture_imgs/eg2-2.png")
ggsave("eg2-barcomp.png", plot=eg2_comp)
knitr::include_graphics("eg2-barcomp.png")
kable(eg2_difference_table)
kable(eg2_summary_stats)

knitr::include_graphics("../gesture_imgs/eg3-0.png")
knitr::include_graphics("../gesture_imgs/eg3-1.png")
knitr::include_graphics("../gesture_imgs/eg3-2.png")
ggsave("eg3-barcomp.png", plot=eg3_comp)
knitr::include_graphics("eg3-barcomp.png")
kable(eg3_difference_table)
kable(eg3_summary_stats)

knitr::include_graphics("../gesture_imgs/eg4-0.png")
knitr::include_graphics("../gesture_imgs/eg4-1.png")
knitr::include_graphics("../gesture_imgs/eg4-2.png")
ggsave("eg4-barcomp.png", plot=eg4_comp)
knitr::include_graphics("eg4-barcomp.png")
kable(eg4_difference_table)
kable(eg4_summary_stats)
```


### Questions from Stacy:
Q: How do we tell whether people HAD an interpretation, or if it was uniform confusion?
A: Let's see a pie chart of things rated "high" maybe?
```{r strong_interpretation_buckets}

get_strong_interpretation_graphs <- function(dat, gest="WG1") {
  d <- dat %>%
  mutate("strong_intp"= ahigh + clow) %>%
  gather("score_bucket", "interpretation", 4:6, 9) %>%
  filter(score_bucket == "bmedium" | score_bucket == "strong_intp") %>%
  mutate("culture_bucket"=paste(score_bucket, viewer_culture, sep="_"))

  g <- ggplot(d,aes(x=condition,y=interpretation,fill=factor(culture_bucket)))+
    geom_bar(stat="identity",position="dodge")+
    # uncomment this and change line 1888 to 
    #   mutate("culture_bucket"=paste(viewer_culture, score_bucket, sep="_"))
    # scale_fill_manual("legend", values=c("eastern_strong_intp" = "palevioletred2",
    #                                    "eastern_bmedium" = "steelblue2",
    #                                    "western_bmedium" = "steelblue4",
    #                                    "western_strong_intp" = "palevioletred4")) + 
    # uncomment this and change line 1888 to 
    # mutate("culture_bucket"=paste(score_bucket, viewer_culture, sep="_"))
    scale_fill_manual("legend", values=c("strong_intp_eastern" = "palevioletred2",
                                       "bmedium_eastern" = "steelblue2",
                                       "bmedium_western" = "steelblue4",
                                       "strong_intp_western" = "palevioletred4")) +
    xlab("Gesture Condition")+ylab("Number of participants whose score was within bucket")+
    ggtitle(paste("Bucketed scores (strong vs weak interpretation) for", gest, sep=" ")) + 
    facet_wrap("group")
  return(g)
}
t <- get_strong_interpretation_graphs(wg1_summary_stats)
```

The way to interpret this graph is the blues are the medium values, the pinks are the extreme (high+ low) values. The light is eastern, the dark is western. The blue being higher than the pinks indicate that there was NOT a strong interpretation -- that is, more people ranked it 3,4,5 than EITHER 1,2 or 6,7 -- that is to say, they chose a weaker rather than stronger interpretation. This is particularly clear in the case of the conflict condition for westerners in WG1 -- note that there is a very strong clear interpretation for westerners, but not at all for easterners. 

```{r display_strong_interpretation_buckets}
wg1_strong_int_graph <- get_strong_interpretation_graphs(wg1_summary_stats, "WG1")
wg2_strong_int_graph <- get_strong_interpretation_graphs(wg2_summary_stats, "WG2")
wg3_strong_int_graph <- get_strong_interpretation_graphs(wg3_summary_stats, "WG3")
wg4_strong_int_graph <- get_strong_interpretation_graphs(wg4_summary_stats, "WG4")
wg5_strong_int_graph <- get_strong_interpretation_graphs(wg5_summary_stats, "WG5")

eg1_strong_int_graph <- get_strong_interpretation_graphs(eg1_summary_stats, "EG1")
eg2_strong_int_graph <- get_strong_interpretation_graphs(eg2_summary_stats, "EG2")
eg3_strong_int_graph <- get_strong_interpretation_graphs(eg3_summary_stats, "EG3")
eg4_strong_int_graph <- get_strong_interpretation_graphs(eg4_summary_stats, "EG4")
```


Display these bad puppies now
```{r display_cultural_bucket_bars_strong_interpret}
knitr::include_graphics("../gesture_imgs/wg1-0.png")
knitr::include_graphics("../gesture_imgs/wg1-1.png")
knitr::include_graphics("../gesture_imgs/wg1-2.png")
ggsave("wg1-barcomp.png", plot=wg1_comp)
knitr::include_graphics("wg1-barcomp.png")
kable(wg1_difference_table)
kable(wg1_summary_stats)

knitr::include_graphics("../gesture_imgs/wg2-0.png")
knitr::include_graphics("../gesture_imgs/wg2-1.png")
knitr::include_graphics("../gesture_imgs/wg2-2.png")
ggsave("wg2-barcomp.png", plot=wg2_comp)
knitr::include_graphics("wg2-barcomp.png")
kable(wg2_difference_table)
kable(wg2_summary_stats)

knitr::include_graphics("../gesture_imgs/wg3-0.png")
knitr::include_graphics("../gesture_imgs/wg3-1.png")
knitr::include_graphics("../gesture_imgs/wg3-2.png")
ggsave("wg3-barcomp.png", plot=wg3_comp)
knitr::include_graphics("wg3-barcomp.png")
kable(wg3_difference_table)
kable(wg3_summary_stats)

knitr::include_graphics("../gesture_imgs/wg4-0.png")
knitr::include_graphics("../gesture_imgs/wg4-1.png")
knitr::include_graphics("../gesture_imgs/wg4-2.png")
ggsave("wg4-barcomp.png", plot=wg4_comp)
knitr::include_graphics("wg4-barcomp.png")
kable(wg4_difference_table)
kable(wg4_summary_stats)

knitr::include_graphics("../gesture_imgs/wg5-0.png")
knitr::include_graphics("../gesture_imgs/wg5-1.png")
knitr::include_graphics("../gesture_imgs/wg5-2.png")
ggsave("wg5-barcomp.png", plot=wg5_comp)
knitr::include_graphics("wg5-barcomp.png")
kable(wg5_difference_table)
kable(wg5_summary_stats)

## EAST
knitr::include_graphics("../gesture_imgs/eg1-0.png")
knitr::include_graphics("../gesture_imgs/eg1-1.png")
knitr::include_graphics("../gesture_imgs/eg1-2.png")
ggsave("eg1-barcomp.png", plot=eg1_comp)
knitr::include_graphics("eg1-barcomp.png")
kable(eg1_difference_table)
kable(eg1_summary_stats)

knitr::include_graphics("../gesture_imgs/eg2-0.png")
knitr::include_graphics("../gesture_imgs/eg2-1.png")
knitr::include_graphics("../gesture_imgs/eg2-2.png")
ggsave("eg2-barcomp.png", plot=eg2_comp)
knitr::include_graphics("eg2-barcomp.png")
kable(eg2_difference_table)
kable(eg2_summary_stats)

knitr::include_graphics("../gesture_imgs/eg3-0.png")
knitr::include_graphics("../gesture_imgs/eg3-1.png")
knitr::include_graphics("../gesture_imgs/eg3-2.png")
ggsave("eg3-barcomp.png", plot=eg3_comp)
knitr::include_graphics("eg3-barcomp.png")
kable(eg3_difference_table)
kable(eg3_summary_stats)

knitr::include_graphics("../gesture_imgs/eg4-0.png")
knitr::include_graphics("../gesture_imgs/eg4-1.png")
knitr::include_graphics("../gesture_imgs/eg4-2.png")
ggsave("eg4-barcomp.png", plot=eg4_comp)
knitr::include_graphics("eg4-barcomp.png")
kable(eg4_difference_table)
kable(eg4_summary_stats)
```

```